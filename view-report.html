<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Analysis Result</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
      html, body {
        padding: 0;
        margin: 0;
      }

      #container {
        width: 100%;
        height: 100%;
        overflow: hidden;
        position: relative;
      }

      #sidebar {
        width: 300px;
        height: 100%;
        position: fixed;
        right: 0;
        top: 0;
      }
    </style>
</head>
<body>
    <div id="container"> 
    </div>
    <div id="sidebar" class="bg-light p-4 shadow">
      <h5 class="mb-2">Display</h5>

      <div class="row">
        <div class="col-6">Graph:</div>
        <div class="col-6">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="graphDisplay" value="full" id="full" checked>
            <label class="form-check-label" for="full">Full Graph</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="graphDisplay" value="cycles" id="cycles" >
            <label class="form-check-label" for="cycles">Only Cycles</label>
          </div>
        </div>
      </div>

      <div class="mb-3 form-check">
        <input class="form-check-input" type="checkbox" name="showFileNames" id="showFileNames">
        <label class="form-check-label" for="showFileNames">Show file names</label>
      </div> 
    </div>
</body>
<script type="module">
  import * as d3 from "https://cdn.jsdelivr.net/npm/d3@7/+esm";

  const id = (nodeId) => btoa(nodeId).replaceAll('=', '');

  function transformToD3Format(report) {
    const files = Object.keys(report.graph);
    const nodes = files.map((file) => ({ id: file }));
    const links = files.flatMap((file) => report.graph[file].map((target) => ({
      source: file,
      target: target,
    })));

    return { nodes, links };
  }

  function renderGraph(graph, cycles) {
    const width = window.innerWidth;
    const height = window.innerHeight;

    const hasCycle = (node) => {
      return cycles.some(cycle => cycle.some(n => n === node.id))
    };

    const svg = d3
      .select("#container")
      .append("svg")
      .attr("width", width)
      .attr("height", height);

    const zoomGroup = svg.append("g");

    const simulation = d3
      .forceSimulation(graph.nodes)
      .force("link", d3.forceLink(graph.links).id((d) => d.id).distance(100))
      .force("charge", d3.forceManyBody().strength(-300))
      .force("center", d3.forceCenter(width / 2, height / 2));

    svg.append("defs")
      .append("marker")
      .attr("id", "arrowhead")
      .attr("viewBox", "0 -5 10 10")
      .attr("refX", 15) // Adjust to position the arrowhead correctly
      .attr("refY", 0)
      .attr("markerWidth", 6)
      .attr("markerHeight", 6)
      .attr("orient", "auto")
      .append("path")
      .attr("d", "M0,-5L10,0L0,5")
      .attr("fill", "#999"); // Arrow color

    const link = zoomGroup
      .append("g")
      .selectAll("line")
      .data(graph.links)
      .enter()
      .append("line")
      .attr("stroke-width", 2)
      .attr("stroke", "#999")
      .attr("marker-end", "url(#arrowhead)")
      .attr("class", (d) => `link-${id(d.source.id)}-${id(d.target.id)} link-${id(d.target.id)}-${id(d.source.id)}`);

    window.link = link;

    const tooltip = d3.select("#container")
      .append("div")
      .style("opacity", 0)
      .attr("class", "tooltip")
      .style("background-color", "white")
      .style("border", "solid")
      .style("border-width", "2px")
      .style("border-radius", "5px")
      .style("position", "absolute")
      .style("pointer-events", "none")
      .style("padding", "5px");

    const node = zoomGroup
      .append("g")
      .selectAll("circle")
      .data(graph.nodes)
      .enter()
      .append("g") 
      .attr("class", (d) => `node-${id(d.id)}`)
      .attr("transform", d => `translate(${d.x},${d.y})`)
      .call(
        d3.drag()
          .on("start", (event, d) => {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
          })
          .on("drag", (event, d) => {
            d.fx = event.x;
            d.fy = event.y;
          })
          .on("end", (event, d) => {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
          })
      );

    node
      .append("circle")
      .attr("r", 5)
      .attr("fill", (d) => hasCycle(d) ? "grey" : "green")
      .attr("stroke", "black")
      .on("mouseover", (event, d) => {
        d3.selectAll(`.node-${id(d.id)}`).selectAll('circle').attr("fill", "red");

        d.cycles = cycles.filter(cycle => cycle.some(n => n === d.id));

        tooltip
          .style("opacity", 1);

        // Highlight connected links
        // d3.selectAll(`.link-${btoa(d.id).replaceAll('=', '')}`).attr("stroke", "red");

        d.cycles.forEach(cycle => {
          cycle.forEach((n, i) => {
            const next = cycle[(i + 1) % cycle.length];
            d3.selectAll(`.link-${id(n)}-${id(next)}`).attr("stroke", "red");
            d3.selectAll(`.node-${id(n)}`).selectAll('circle').attr("fill", "red");
          })
        })
      })
      .on("mousemove", function (event, d) {
        tooltip
          .html(`
              File: <code>${d.id}</code><br>
              Cycles (${d.cycles.length}) (${new Set(d.cycles.flat()).size} files):<br>
                  ${d.cycles.map((cycle, i) => `
                  <p>
                      Cycle #${i + 1} (${cycle.length} files):
                      <pre>${cycle.join('<br>->')}<br>->${cycle[0]}</pre>
                  </p>`).join('<br>')}`)
          .style("left", event.pageX + "px")
          .style("top", event.pageY + "px")
      })
      .on("mouseout", (event, d) => {
        d3.selectAll(`.node-${id(d.id)}`).selectAll('circle').attr("fill", (d) => hasCycle(d) ? "grey" : "green");

        tooltip
          .style("opacity", 0);

        // Reset connected links
        // d3.selectAll(`.link-${btoa(d.id).replaceAll('=', '')}`).attr("stroke", "#999");

        d.cycles.forEach(cycle => {
          cycle.forEach((n, i) => {
            const next = cycle[(i + 1) % cycle.length];
            d3.selectAll(`.link-${id(n)}-${id(next)}`).attr("stroke", "#999");
            d3.selectAll(`.node-${id(n)}`).selectAll('circle').attr("fill", (ds) => hasCycle(ds) ? "grey" : "green");
          })
        })
      });

    node.append('text').attr('dx', '5').attr('visibility', 'hidden').text(d => d.id);

    window.node = node;


    // Add zoom and pan behavior
    const zoom = d3.zoom()
      .scaleExtent([0.1, 10]) // Set zoom scale limits
      .on("zoom", (event) => {
        zoomGroup.attr("transform", event.transform); // Apply zoom and pan transformations
      });

    svg.call(zoom); // Enable zoom on the SVG element

    simulation.on("tick", () => {
      link
        .attr("x1", (d) => d.source.x)
        .attr("y1", (d) => d.source.y)
        .attr("x2", (d) => d.target.x)
        .attr("y2", (d) => d.target.y);

      node.attr("transform", d => `translate(${d.x},${d.y})`);
    });
  }

  if (window.report) {
    const data = transformToD3Format(report);
    renderGraph(data, report.cycles);
  }

  // Controls
  document.querySelectorAll('[name=graphDisplay]').forEach(control => {
    control.onchange = () => {
      const linkDisplay = document.querySelector("[name=graphDisplay]:checked").value;
      if (linkDisplay === "full") {
        link.attr("opacity", "1");
        node.attr("opacity", "1");
      } else {
        link.attr("opacity", "0");
        node.attr("opacity", "0");
        report.cycles.forEach(cycle => {
          cycle.forEach((n, i) => {
            const next = cycle[(i + 1) % cycle.length];
            d3.selectAll(`.link-${id(n)}-${id(next)}`)
              .attr("opacity", "1")
              .attr("stroke", "#999");
            d3.selectAll(`.node-${id(n)}`).attr("opacity", "1");
          })
        })
      }
    }
  });

  document.querySelector('[name=showFileNames]').onchange = (e) => {
    const isEnabled = e.target.checked;

    if (isEnabled) {
      node.select('text').attr('visibility', 'visible');
    } else {
      node.select('text').attr('visibility', 'hidden');
    }
  }
</script>
</html>